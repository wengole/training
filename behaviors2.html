

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>31. More complex behaviors &mdash; Mastering Plone 1.2 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
    <link rel="top" title="Mastering Plone 1.2 documentation" href="index.html"/>
        <link rel="next" title="32. A viewlet for the voteable behavior" href="viewlets_2.html"/>
        <link rel="prev" title="30. Creating reusable packages with eggs" href="eggs2.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Mastering Plone</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intro.html#who-are-we">Who are we?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#who-are-you">Who are you?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#what-will-we-do">What will we do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#what-will-we-not-do">What will we not do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#what-to-expect">What to expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">2. Installation &amp; Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#installing-plone">Installing Plone</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#hosting-plone">Hosting Plone</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plone_training_config/instructions.html">3. Installing Plone for the Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#install-virtualbox">Install VirtualBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#install-and-configure-vagrant">Install and configure Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#what-vagrant-does">What Vagrant does</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="case.html">4. The Case-Study</a><ul>
<li class="toctree-l2"><a class="reference internal" href="case.html#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="case.html#requirements">Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="anatomy.html">5. The Anatomy of Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="anatomy.html#zope2">Zope2</a></li>
<li class="toctree-l2"><a class="reference internal" href="anatomy.html#content-management-framework">Content Management Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="anatomy.html#zope-toolkit-zope3">Zope Toolkit / Zope3</a></li>
<li class="toctree-l2"><a class="reference internal" href="anatomy.html#pyramid">Pyramid</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="features.html">6. The Features of Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="features.html#starting-and-stopping-plone">Starting and Stopping Plone</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#users">Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#configure-a-mailserver">Configure a Mailserver</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#walktrough-of-the-ui">Walktrough of the UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#content-types">Content-Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#folders">Folders</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#collections">Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#content-rules">Content Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#history">History</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#manage-members-and-groups">Manage members and groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#workflows">Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#working-copy">Working copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#placeful-workflows">Placeful workflows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuring_customizing.html">7. Configuring and Customizing Plone through the web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#the-control-panel">The Control Panel</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#portlets">Portlets</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#viewlets">Viewlets</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#zmi">ZMI</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">8. Extending Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extending.html#extension-technologies">Extension technologies</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html#what-are-components-what-is-zcml">What are components, what is ZCML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="addons.html">9. Extend Plone with Add-ons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="addons.html#how-to-find-addons">How to find addons</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#some-noteable-addons">Some noteable addons</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#installing-addons">Installing Addons</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#ploneformgen">PloneFormGen</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#add-photogallery-with-collective-plonetruegallery">Add Photogallery with collective.plonetruegallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#internationalisation">Internationalisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">10. Theming</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildout_1.html">11. Buildout I</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs1.html">12. Creating your own eggs to customize Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity.html">13. Dexterity I: Through the web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#what-is-a-content-type">What is a content-type?</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#dexterity-and-archetypes-a-comparison">Dexterity and Archetypes - A Comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#modifying-existing-types">Modifying existing types</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#creating-content-types-ttw">Creating content-types TTW</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#moving-content-types-into-code">Moving content-types into code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_1.html">14. Views I</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_1.html#a-simple-browser-view">A simple browser view</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="zpt.html">15. Zope Page Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#tal-and-tales">TAL and TALES</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#metal-and-macros">METAL and macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#accessing-plone-from-the-template">Accessing Plone from the template</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#what-we-missed">What we missed</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#chameleon">Chameleon</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="zpt_2.html">16. Customizing existing templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#newsitem-pt">newsitem.pt</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#summary-view-pt">summary_view.pt</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#finding-the-right-template">Finding the right template</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#skin-templates">skin-templates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_2.html">17. Views II: A default view for &#8220;talk&#8221;</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_2.html#view-classes">View-Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_2.html#the-default-view">The default-view</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_3.html">18. Views III: A Talk list</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#using-portal-catalog">Using portal_catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#brains-and-objects">brains and objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#querying-the-catalog">Querying the catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#the-template-for-the-listing">The template for the listing</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#setting-a-custom-view-as-default-view-on-an-object">Setting a custom view as default-view on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#adding-some-javascript-collective-js-datatables">Adding some javascript (collective.js.datatables)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="behaviors1.html">19. Behaviors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="behaviors1.html#dexterity-approach">Dexterity Approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="behaviors1.html#names-and-theory">Names and Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="behaviors1.html#practical-example">Practical example</a></li>
<li class="toctree-l2"><a class="reference internal" href="behaviors1.html#adding-it-to-our-talk">Adding it to our talk</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="viewlets_1.html">20. Writing Viewlets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="viewlets_1.html#a-viewlet-for-the-social-behavior">A viewlet for the social behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewlets_1.html#social-viewlet">social-viewlet</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">21. Programming Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#plone-api">plone.api</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#portal-tools">portal-tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#debugging">Debugging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ide.html">22. IDE&#8217;s and Editors</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_2.html">23. Dexterity Types II: Growing up</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#add-a-marker-interface-to-the-talk-type">Add a marker-interface to the talk-type</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#upgrade-steps">Upgrade-steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#add-a-browserlayer">Add a browserlayer</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#add-catalog-indexes">Add catalog-indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#query-for-custom-indexes">Query for custom indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#add-collection-criteria">Add collection criteria</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity_2.html#add-more-features-through-generic-setup">Add more features through generic-setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="custom_search.html">24. Custom search</a><ul>
<li class="toctree-l2"><a class="reference internal" href="custom_search.html#eea-facetednavigation">eea.facetednavigation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="events.html">25. Turn talks into events</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_generated_content.html">26. User generated content</a><ul>
<li class="toctree-l2"><a class="reference internal" href="user_generated_content.html#self-registration">Self-registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_generated_content.html#a-custom-workflow-for-talks">A custom workflow for talks</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_generated_content.html#grant-local-roles">Grant local roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_generated_content.html#move-the-changes-to-the-file-system">Move the changes to the file-system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ressources.html">27. Ressources</a></li>
<li class="toctree-l1"><a class="reference internal" href="thirdparty_behaviors.html">28. Using third-party behaviors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="thirdparty_behaviors.html#add-teaser-with-collective-behavior-banner">Add teaser with collective.behavior.banner</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_3.html">29. Dexterity Types III: Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs2.html">30. Creating reusable packages with eggs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">31. More complex behaviors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-annotations">Using Annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-schema">Using Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-code">Writing Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="viewlets_2.html">32. A viewlet for the voteable behavior</a><ul>
<li class="toctree-l2"><a class="reference internal" href="viewlets_2.html#voting-viewlet">Voting Viewlet</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewlets_2.html#writing-the-viewlet-code">Writing the Viewlet code</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewlets_2.html#the-template">The template</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewlets_2.html#the-javascript-code">The javascript code</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewlets_2.html#writing-2-simple-view-helpers">Writing 2 simple view helpers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reusable.html">33. Making our package reusable</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reusable.html#adding-permissions">Adding permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="reusable.html#using-our-permissions">Using our permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="reusable.html#provide-defaults">Provide defaults</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="embed.html">34. Using starzel.votable_behavior in ploneconf.site</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_sites.html">35. Buildout II: Deploying your site</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment_sites.html#the-starzel-buildout">The starzel-buildout</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment_sites.html#other-tools-we-use">Other tools we use</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="future_of_plone.html">36. The Future of Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="optional.html">37. Optional</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Mastering Plone</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>31. More complex behaviors</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="more-complex-behaviors">
<h1>31. More complex behaviors<a class="headerlink" href="#more-complex-behaviors" title="Permalink to this headline">¶</a></h1>
<div class="section" id="using-annotations">
<h2>Using Annotations<a class="headerlink" href="#using-annotations" title="Permalink to this headline">¶</a></h2>
<p>We are going to store the information in an annotation. Not because it is needed but because you will find code that uses annotations and need to understand the implications.</p>
<p><a class="reference external" href="https://pypi.python.org/pypi/zope.annotation/4.2.0">Annotations</a> in Zope/Plone mean that data won&#8217;t be stored directly on an object but in an indirect way and with namespaces so that multiple packages can store information under the same attribute, without colliding.</p>
<p>So using annotations avoids namespace conflicts. The cost is an indirection. The dictionary is persistent so it has to be stored separately. Also, one could give attributes a name containing a namespace prefix to avoid naming collisions.</p>
</div>
<div class="section" id="using-schema">
<h2>Using Schema<a class="headerlink" href="#using-schema" title="Permalink to this headline">¶</a></h2>
<p>The attribute where we store our data will be declared as a schema field. We mark the field as a ommitted field, because we are not going to create z3c.form widgets for displaying them. We do provide a schema, because many other packages use the schema information to get knowledge of the relevant fields.</p>
<p>For example, when files have been migrated to blobs, new objects had to be created and every schema field was copied. The code can&#8217;t know about our field, except if we provide schema information.</p>
</div>
<div class="section" id="writing-code">
<h2>Writing Code<a class="headerlink" href="#writing-code" title="Permalink to this headline">¶</a></h2>
<p>To start, we create a directory <tt class="file docutils literal"><span class="pre">behavior</span></tt> with an empty <tt class="file docutils literal"><span class="pre">behavior/__init__.py</span></tt> file.</p>
<p>Next we must, as always, register our zcml.</p>
<p>First, add the information that there will be another zcml file in <tt class="file docutils literal"><span class="pre">configure.zcml</span></tt></p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre>&lt;configure
      ...&gt;

  ...
  &lt;include package=&quot;.behavior&quot; /&gt;
  ...

&lt;/configure&gt;
</pre></div>
</td></tr></table></div>
<p>Next, create <tt class="file docutils literal"><span class="pre">behavior/configure.zcml</span></tt></p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;configure</span>
    <span class="na">xmlns=</span><span class="s">&quot;http://namespaces.zope.org/zope&quot;</span>
    <span class="na">xmlns:plone=</span><span class="s">&quot;http://namespaces.plone.org/plone&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;plone:behavior</span>
      <span class="na">title=</span><span class="s">&quot;Voting&quot;</span>
      <span class="na">description=</span><span class="s">&quot;Allow voting for an item&quot;</span>
      <span class="na">provides=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVoting&quot;</span>
      <span class="na">factory=</span><span class="s">&quot;.voting.Vote&quot;</span>
      <span class="na">marker=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVotable&quot;</span>
      <span class="nt">/&gt;</span>

<span class="nt">&lt;/configure&gt;</span>
</pre></div>
</td></tr></table></div>
<p>There are some important differences to our first behavior:</p>
<blockquote>
<div><ul class="simple">
<li>There is a marker interface</li>
<li>There is a factory</li>
</ul>
</div></blockquote>
<p>The factory is a class that provides the behavior logic and gives access to the attributes we provide.
Factories in Plone/Zope land are retrieved by adapting an object with an interface.
If I want my behavior, I&#8217;d write <tt class="samp docutils literal"><span class="pre">IVoting(object)</span></tt></p>
<p>But in order for this to work, my object may <em>not</em> be implementing the IVoting interface, because if it would, <tt class="samp docutils literal"><span class="pre">IVoting(object)</span></tt> would return the object itself!
If I need a marker interface for objects providing my behavior, I must provide one, for this we use the marker attribute. My object implements <tt class="samp docutils literal"><span class="pre">IVotable</span></tt> and because of this, we can write views and viewlets just for this content type.</p>
<p>The interfaces need to be written, in our cases into a file <tt class="file docutils literal"><span class="pre">interfaces.py</span></tt>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">plone</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">plone.autoform</span> <span class="kn">import</span> <span class="n">directives</span> <span class="k">as</span> <span class="n">form</span>
<span class="kn">from</span> <span class="nn">plone.autoform.interfaces</span> <span class="kn">import</span> <span class="n">IFormFieldProvider</span>
<span class="kn">from</span> <span class="nn">plone.supermodel</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">plone.supermodel</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">zope</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">alsoProvides</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">Interface</span>

<span class="k">class</span> <span class="nc">IVotableLayer</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marker interface for the Browserlayer</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c"># Ivotable is the marker interface for contenttypes how support this behavior</span>
<span class="k">class</span> <span class="nc">IVotable</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># This is the behaviors interface. When doing IVoting(object),you receive an</span>
<span class="c"># adapter</span>
<span class="k">class</span> <span class="nc">IVoting</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">():</span>
        <span class="n">form</span><span class="o">.</span><span class="n">omitted</span><span class="p">(</span><span class="s">&quot;votes&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">omitted</span><span class="p">(</span><span class="s">&quot;voted&quot;</span><span class="p">)</span>

    <span class="n">directives</span><span class="o">.</span><span class="n">fieldset</span><span class="p">(</span>
        <span class="s">&#39;debug&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s">u&#39;debug&#39;</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;votes&#39;</span><span class="p">,</span> <span class="s">&#39;voted&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">votes</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">tite</span><span class="o">=</span><span class="s">&quot;Vote info&quot;</span><span class="p">,</span>
                        <span class="n">key_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Voted number&quot;</span><span class="p">),</span>
                        <span class="n">value_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Voted so often&quot;</span><span class="p">),</span>
                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">voted</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Vote hashes&quot;</span><span class="p">,</span>
                        <span class="n">value_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">TextLine</span><span class="p">(),</span>
                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store the vote information, store the request hash to ensure</span>
<span class="sd">        that the user does not vote twice</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">average_vote</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the average voting for an item</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether anybody ever voted for this item</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">already_voted</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the information wether a person already voted.</span>
<span class="sd">        This is not very high level and can be tricked out easily</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the votes. Should only be called by admins</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="n">alsoProvides</span><span class="p">(</span><span class="n">IVoting</span><span class="p">,</span> <span class="n">IFormFieldProvider</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This is a lot of code. The IVotableLayer we will need later for viewlets and browser views. Lets add it right here.
The IVotable interface is the simple marker interface. It will only be used to bind browser views and viewlets to content types that provide our behavior, so no code needed.</p>
<p>The IVoting class is more complex, as you can see. While IVoting is just an interface, we use <tt class="samp docutils literal"><span class="pre">plone.supermodel.model.Schema</span></tt> for advanced dexterity features.
Zope.schema provides no means for hiding fields. The directives <tt class="samp docutils literal"><span class="pre">form.omitted</span></tt> from <tt class="samp docutils literal"><span class="pre">plone.autoform</span></tt> allow us to annotate this additional information so that the autoform renderers for forms can use the additional information.</p>
<p>We make this omit conditional. If we run Plone in debug mode, we will be able to see the internal data in the edit form.</p>
<p>We create minimal schema fields for our internal data structures. For a small test, I removed the form omitted directives and opened the edit view of a talk that uses the behavior. After seeing the ugliness, I decided that I should provide at least  minimum of information. Titles and required are purely optional, but very helpful if the fields won&#8217;t be omitted, something that can be helpful when debugging the behavior.
Later, when we implement the behavior, the <tt class="samp docutils literal"><span class="pre">votes</span></tt> and <tt class="samp docutils literal"><span class="pre">voted</span></tt> attributes are implemented in such a way that you can&#8217;t just modify these fields, they are read only.</p>
<p>Then we define the API that we are going to use in browser views and viewlets.</p>
<p>The last line ensures that the schema fields are known to other packages. Whenever some code wants all schemas from an object, he receives the schema defined directly on the object and the additional schemata. Additional schemata are compiled by looking for behaviors and whether they provide the <tt class="samp docutils literal"><span class="pre">IFormFieldProvider</span></tt> functionality. Only then we fields are known as schema fields.</p>
<p>Now the only thing that is missing is the behavior, which we must put into <tt class="file docutils literal"><span class="pre">behavior/voting.py</span></tt></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">persistent.dict</span> <span class="kn">import</span> <span class="n">PersistentDict</span>
<span class="kn">from</span> <span class="nn">persistent.list</span> <span class="kn">import</span> <span class="n">PersistentList</span>
<span class="kn">from</span> <span class="nn">zope.annotation.interfaces</span> <span class="kn">import</span> <span class="n">IAnnotations</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="s">&quot;starzel.votable_behavior.behavior.voting.Vote&quot;</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">KEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">({</span>
                <span class="s">&quot;voted&quot;</span><span class="p">:</span> <span class="n">PersistentList</span><span class="p">(),</span>
                <span class="s">&#39;votes&#39;</span><span class="p">:</span> <span class="n">PersistentDict</span><span class="p">()</span>
                <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;votes&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">voted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;voted&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>In our <tt class="samp docutils literal"><span class="pre">__init__</span></tt> method we get <em>annotations</em> from the object.
We look for data with a specific key.</p>
<p>The key in this example is the same as what I would get with <tt class="samp docutils literal"><span class="pre">__name__+Vote.__name__</span></tt>. But we won&#8217;t create a dynamic name, this would be very clever and clever is bad.</p>
<p>By declaring a static name, we won&#8217;t run into problems if we restructure the code.</p>
<p>You can see, that we initialize the data if it doesn&#8217;t exist. We work with PersistentDict and PersistentList. To understand why we do this, it is important to understand how the ZODB works.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p>The ZODB can store objects. It has a special root object that you will never touch. Whatever you store where, will be part of the root object, except if it is an object sublclassing <tt class="samp docutils literal"><span class="pre">persistent.Persistent</span></tt> Then it will be stored independently.</p>
<p>Zope/ZODB Persistent objects note when you change an attribute on it and mark itself as changed. Changed objects will be saved to the database. This happens automatically. Each request begins a transaction and after our code ran and the Zope Server is preparing to send back the response we generated, the transaction will be committed and everything we changed will be saved.</p>
<p>Now, if have a normal dictionary on a persistent object, and you will only change the dictionary, the persistent object has no way to know, if the dictionary has been changed. This <a class="reference external" href="https://github.com/plone/Products.CMFEditions/commit/5c07c72bc8701cf28c9cc68ad940186b9e296ddf">happens</a> from time to time.</p>
<p>So one solution is to change the special attribute <tt class="samp docutils literal"><span class="pre">_p_changed</span></tt> to <tt class="samp docutils literal"><span class="pre">True</span></tt> on the persistent object, or to use a PersistentDict. That is what we are doing here.</p>
<p class="last">You can find more information in the documentation of the ZODB, in particular <a class="reference external" href="http://www.zodb.org/en/latest/documentation/guide/prog-zodb.html#rules-for-writing-persistent-classes">Rules for Persistent Classes</a></p>
</div>
<p>Next we provide the internal fields via properties. Using this form of property, makes them read only property, as we did not define write handlers. We don&#8217;t need them so we won&#8217;t add them.</p>
<p>As you have seen in the Schema declaration, if you run your site in debug mode, you will see an edit field for these fields. But trying to change these fields will throw an exception.</p>
<p>Lets continue with this file:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hash can be tricked out by changing IP addresses and might allow</span>
<span class="sd">        only a single person of a big company to vote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hash_</span> <span class="o">=</span> <span class="n">md5</span><span class="p">()</span>
        <span class="n">hash_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">getClientAddr</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;User-Agent&quot;</span><span class="p">,</span> <span class="s">&quot;Accept-Language&quot;</span><span class="p">,</span>
                    <span class="s">&quot;Accept-Encoding&quot;</span><span class="p">]:</span>
            <span class="n">hash_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">getHeader</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vote</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_voted</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;You may not vote twice&quot;</span><span class="p">)</span>
        <span class="n">vote</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;voted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="n">votes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;votes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vote</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">votes</span><span class="p">:</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">vote</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">vote</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">average_vote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">total_votes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;votes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">total_points</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">vote</span> <span class="o">*</span> <span class="n">count</span> <span class="k">for</span> <span class="p">(</span><span class="n">vote</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="ow">in</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;votes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_points</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_votes</span>

    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;votes&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">already_voted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s">&#39;voted&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">({</span><span class="s">&#39;voted&#39;</span><span class="p">:</span> <span class="n">PersistentList</span><span class="p">(),</span>
                                           <span class="s">&#39;votes&#39;</span><span class="p">:</span> <span class="n">PersistentDict</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>We start with a little helper method which is not exposed via the interface. We don&#8217;t want people to vote twice. There are many ways to ensure this and each one has flaws.</p>
<p>We chose this way to show you how to access information from the request the browser of the user sent to us. First, we get the ip of the user, then we access a small bunch of headers from the users browser and generate an md5 checksum of this.</p>
<p>The vote method, wants a vote and a request. We check the preconditions, then we convert the vote to an integer, store the request has to <tt class="samp docutils literal"><span class="pre">voted</span></tt> and the votes into the <tt class="samp docutils literal"><span class="pre">votes</span></tt> dictionary. We just count there, how often any vote has been given.</p>
<p>Everything else is just boring python.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="viewlets_2.html" class="btn btn-neutral float-right" title="32. A viewlet for the voteable behavior"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="eggs2.html" class="btn btn-neutral" title="30. Creating reusable packages with eggs"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Philip Bauer, Patrick Gerken. Version 1.2.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>